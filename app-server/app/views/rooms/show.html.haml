%div.template
  %div#message-bubble-template
    %div.message
      %div.message-user-name
      %div.message-body
        %p.text
      %div.time

%div#room{data: { room_id: @room.id, current_user_id: current_user.id } }
  %div.talk-container.flex-layout-box
    %nav.navbar.navbar-default.navbar-fixed-top
      .container-fluid
        %ul.nav.navbar-nav.navbar-left
          %li
            = link_to root_path, class: 'navbar-brand' do
              = "##{@room.name}"
          %li
            %a{href: '#'} range: 5km

    %div.messages

    %nav.navbar.navbar-default.navbar-fixed-bottom
      = form_for @room.messages.new, format: :json, class: 'message-composer', remote: true do |f|
        = f.text_area :body, class: 'form-control', row: 1, placeholder: 'メッセージを入力'
        = f.hidden_field :room_id, value: @room.id
        = f.submit '送信', class: 'btn btn-default'
        - # 以下はハリボテ
        %button.btn.btn-default
          %i.fa.fa-photo
        %button.btn.btn-default
          %i.fa.fa-map-marker

:javascript
  $(document).ready(function(){
    roomId = $('#room').data('room-id');
    currentUserId = $('#room').data('current-user-id');
    template = $('#message-bubble-template');
    messages = $('#room .messages');

    insertMessageBubble = function(messageData){
      message = template.clone();

      if(messageData['user']['id'] == currentUserId) {
        message.find('.message').addClass('message-sent');
      } else {
        message.find('.message').addClass('message-received');
      }

      message.find('.message-user-name').text(messageData['user']['name']);
      message.find('.message-body p.text').text(messageData['body']);
      message.find('.time').text(messageData['created_at']);
      messages.append(message);
      window.scrollTo(0, document.body.scrollHeight)
    }

    $.getJSON([ '/messages.json?room_id=', roomId ].join(''), function(data){
      data['messages'].forEach(function(messageData){
        insertMessageBubble(messageData);
      });
    });
    ws = new WebSocket("ws://127.0.0.1:8080/")
    ws.addEventListener('message', function(event){
      console.log(event.data);
      messageData = JSON.parse(event.data);
      insertMessageBubble(messageData);
      if(messageData['body'] == $('#message_body').val()) {
        $('#message_body').val('')
      }
    });

    // すべてが終わったらスクロールさせる
  });
